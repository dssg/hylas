<html>
    <head>
        <!-- Angular Material Dependencies -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-animate.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-aria.min.js"></script>
        <script src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.14.3.js"></script>

        <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
        <!--http://stackoverflow.com/questions/23205420/how-can-i-get-angular-ui-bootstrap-tabs-to-fill-the-remaining-height-->
        <style type="text/css">
             html, body, .tabset, .tab-content, .tab-pane, .tabbable {
                  height:100%;
             }
             .tab-content {
                  height:100%;
             }
        </style>
    </head>
    <body>

        <div ng-app="univisApp" ng-controller="univisCtrl">
            <uib-accordion> 
                <uib-accordion-group heading="Models" 
                    is-open="models_open"> 
                    <table>
                        <tr>
                            <th></th>
                            <th>Classifier Name</th>
                            <th>Time</th>
                        </tr>
                        <tr ng-repeat="model in model_list">
                            <td> 
                                <button type="button" ng-click="pickModel($index)">
                                    Examine
                                </button>
                            </td>
                            <td> {{ model.name }} </td>
                            <td> {{ model.time }} </td>
                        </tr>
                    </table>
                </uib-accordion-group>
            <uib-accordion-group heading="Model performance" 
                is-open="model_performance_open">
                <div>
                    model perf goes here
                </div>
                <table>
                    <tr>
                        <th></th>
                        <th>Score</th>
                        <th>Unit ID</th>
                    </tr>
                    <tr ng-repeat="unit in top_units">
                        <td> 
                            <button type="button" ng-click="pickUnit($index, 'top')">
                                Examine
                            </button>
                        </td>
                        <td> {{ unit.score }} </td>
                        <td> {{ unit.unit_id }} </td>
                    </tr>
                </table>
            </uib-accordion-group>
            <uib-accordion-group heading="Unit performance" 
                is-open="unit_performance_open">
                <uib-tabset>
                    <uib-tab heading="Distributions">
                        {{ unit }}<br>
                        distribution info goes here
                    </uib-tab>
                    <uib-tab heading="Similar">
                        <div class="btn-group" uib-dropdown>
                            <button type="button" class="btn btn-primary" 
                                uib-dropdown-toggle> 
                                {{similar_feature}} <span class="caret"></span>
                            </button>
                            <ul class="uib-dropdown-menu" role="menu" 
                                aria-labelledby="single-button">
                                <li role="menuitem"
                                    ng-repeat="feature in top_n_feature_names">
                                    <a 
                                        ng-click="pickSimilarFeature(feature)">
                                        {{feature}}
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <table>
                            <tr>
                                <th></th>
                                <th>{{similar_feature}}</th>
                                <th>Unit ID</th>
                            </tr>
                            <tr ng-repeat="unit in similar_units">
                                <td> 
                                    <button type="button" ng-click="pickUnit($index, 'similar')">
                                        Examine
                                    </button>
                                </td>
                                <td> {{ unit[similar_feature] }} </td>
                                <td> {{ unit.unit_id }} </td>
                            </tr>
                        </table>
                    </uib-tab>
                </uib-tabset>
            </uib-accordion-group>
            </uib-accordion>
        </div>

        <script>
            var app = angular.module('univisApp', ['ui.bootstrap']);
            app.controller('univisCtrl', function($scope, $http) {

                $scope.pickModel = function ($index) {
                    $scope.model_id = $index;
                    console.log('model id= ' + $scope.model_id);
                    $http.get('/top_units', {'params': 
                        {'model_id' : $scope.model_id}})
                        .then( function (response) {
                            $scope.top_units = angular.fromJson(
                                response.data).data;
                        }, function (response) {});
                    $http.get('/top_features', {'params': 
                        {'model_id' : $scope.model_id}})
                        .then( function (response) {
                            $scope.top_features = angular.fromJson(
                                response.data).data;
                            $scope.top_n_feature_names.length = 0;
                            for (var i = 0; i < 3; ++i) {
                                $scope.top_n_feature_names.push($scope.top_features[i].feature);
                            }
                            console.log('top_n_feature_names');
                            console.log($scope.top_n_feature_names);
                        }, function (response) {});
                    $scope.model_performance_open = true;
                }

                $http.get('/list_models').then( function (response) {
                    $scope.model_list = angular.fromJson(response.data).data;
                    $scope.models_open = true;
                }, function (response) {});

                $scope.pickUnit = function ($index, pool) {
                    if (pool === 'similar') {
                        $scope.unit_id = $scope.similar_units[$index].unit_id;
                    } else {
                        $scope.unit_id = $scope.top_units[$index].unit_id;
                    }
                    console.log('unit id= ' + $scope.unit_id);
                    var feature_list = $scope.top_n_feature_names.join(',');
                    $http.get('/unit', {'params': {
                        'model_id': $scope.model_id,
                        'unit_id': $scope.unit_id,
                        'features': feature_list}})
                        .then( function (response) {
                            $scope.unit = angular.fromJson(
                                response.data).data;
                        }, function (response) {});
                    $scope.unit_performance_open=true;
                }

                $scope.pickSimilarFeature = function (feature) {
                    $scope.similar_feature = feature;
                    console.log('similar feature = ' + $scope.similar_feature);
                    $http.get('/similar', {'params': {
                        'model_id': $scope.model_id,
                        'unit_id': $scope.unit_id,
                        'features': feature}})
                        .then( function (response) {
                            $scope.similar_units = angular.fromJson(
                                response.data).data;
                        }, function (response) {});
                }

                $scope.models_open = false;
                $scope.model_performance_open = false;
                $scope.unit_performance_open = false;

                $scope.model_list = [];
                $scope.top_features = [];
                $scope.top_n_feature_names = [];
                $scope.top_units = [];
                $scope.unit = {};
                $scope.similar_feature = 'Choose a Feature'
                $scope.similar_units = [];
            });
        </script>
    </body>
</html>

